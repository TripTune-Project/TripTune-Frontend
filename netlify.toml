# Netlify 설정 파일
# TripTune Frontend 보안 및 성능 최적화

[build]
  command = "rm -rf .next && npm run build"
  publish = ".next"

[build.environment]
  NODE_VERSION = "18"

# Next.js 플러그인 설정 (빌드 전에 위치)
[[plugins]]
  package = "@netlify/plugin-nextjs"

# 보안 헤더 설정
[[headers]]
  for = "/*"
  [headers.values]
    # Content Security Policy (Report-Only 모드로 시작)
    # 실제 차단 없이 위반 사항만 로그로 수집
    Content-Security-Policy-Report-Only = """
      default-src 'self';
      script-src 'self' 'unsafe-inline' 'unsafe-eval'
        https://www.googletagmanager.com
        https://www.google-analytics.com
        https://ssl.google-analytics.com;
      style-src 'self' 'unsafe-inline'
        https://fonts.googleapis.com;
      img-src 'self' data: https: blob:;
      font-src 'self' data:
        https://fonts.gstatic.com;
      connect-src 'self'
        https://www.google-analytics.com
        https://www.triptune.site
        https://www.triptune.co.kr
        https://triptune.s3.ap-northeast-2.amazonaws.com
        wss://www.triptune.site
        wss://www.triptune.co.kr;
      frame-src 'self'
        https://www.google.com;
      object-src 'none';
      base-uri 'self';
      form-action 'self';
      frame-ancestors 'none';
    """

    # X-Frame-Options: 클릭재킹 공격 방지
    X-Frame-Options = "DENY"

    # X-Content-Type-Options: MIME 타입 스니핑 방지
    X-Content-Type-Options = "nosniff"

    # Referrer-Policy: 리퍼러 정보 보안 강화
    Referrer-Policy = "strict-origin-when-cross-origin"

    # X-XSS-Protection: XSS 공격 방지 (구형 브라우저용)
    X-XSS-Protection = "1; mode=block"

    # Permissions-Policy: 브라우저 기능 접근 제어
    Permissions-Policy = "camera=(), microphone=(), geolocation=(self), payment=()"

# 정적 리소스 캐싱 설정
[[headers]]
  for = "/assets/*"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

[[headers]]
  for = "/_next/static/*"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

[[headers]]
  for = "/*.js"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

[[headers]]
  for = "/*.css"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

# 이미지 파일 캐싱 (WebP, AVIF 포함)
[[headers]]
  for = "/*.webp"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"
    Content-Type = "image/webp"

[[headers]]
  for = "/*.avif"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"
    Content-Type = "image/avif"

[[headers]]
  for = "/*.png"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

[[headers]]
  for = "/*.jpg"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

[[headers]]
  for = "/*.jpeg"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

# HTML 파일은 항상 최신 버전 사용
[[headers]]
  for = "/*.html"
  [headers.values]
    Cache-Control = "public, max-age=0, must-revalidate"

# 리다이렉트 설정 (필요시)
# [[redirects]]
#   from = "/old-path"
#   to = "/new-path"
#   status = 301

# 환경별 설정
[context.production]
  [context.production.environment]
    NODE_ENV = "production"

[context.deploy-preview]
  [context.deploy-preview.environment]
    NODE_ENV = "production"
